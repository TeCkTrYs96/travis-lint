#!/usr/bin/env ruby --disable=gems --disable=rubyopt
require 'timeout'

Timeout.timeout(5) do
  require 'uri'
  require 'net/https'
  require 'yaml'

  path     = ARGV[0] || '.travis.yml'
  content  = path == '-' ? $stdin.read : File.read(path)
  uri      = URI.parse("https://api.travis-ci.org/lint")
  response = Net::HTTP.post_form(uri, :content => content)

  response.value
  warnings = YAML.load(response.body)['lint']['warnings']
  warnings.reverse.each do |warning|
    prefix = " " << warning['key'].join('.') << ":" if warning['key'].any?
    puts "-#{prefix} #{warning['message']}"
  end

  exit 1 if warnings.any?
end
